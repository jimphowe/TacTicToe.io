{% extends 'base_game.html' %}
{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
    .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        align-items: stretch;
        color: white;
        z-index: 1000;
        height: 60px;
    }
    .player-info {
        display: flex;
        align-items: center;
        flex: 1;
        padding: 10px 20px;
        transition: all 0.3s ease;
    }
    .player-info.red-side {
        background-color: rgba(60, 50, 50, 0.8);
    }
    .player-info.red-side.active {
        background-color: rgba(140, 65, 55, 0.9);
        box-shadow: inset 0 0 25px rgba(200, 90, 70, 0.4), 0 0 20px rgba(223, 112, 83, 0.5);
    }
    .player-info.blue-side {
        background-color: rgba(50, 55, 65, 0.8);
    }
    .player-info.blue-side.active {
        background-color: rgba(55, 90, 140, 0.9);
        box-shadow: inset 0 0 25px rgba(80, 130, 200, 0.4), 0 0 20px rgba(91, 149, 225, 0.5);
    }
    .player-name {
        font-size: 18px;
        font-weight: bold;
    }
    .player-time {
        font-size: 24px;
        font-weight: bold;
        margin-left: 20px;
        margin-right: 20px;
    }
    .home-button {
        position: fixed;
        top: 70px;
        left: 20px;
        z-index: 1000;
    }
</style>
{% load static %}
<div class="top-bar">
    <div id="player1Info" class="player-info red-side active">
        <span class="player-name">Player 1</span>
        <span id="player1Timer" class="player-time">03:00</span>
    </div>
    <div id="player2Info" class="player-info blue-side" style="justify-content: flex-end;">
        <span id="player2Timer" class="player-time">03:00</span>
        <span class="player-name">Player 2</span>
    </div>
</div>
<a href="/" class="btn btn-outline-light home-button">
    <i class="fas fa-home"></i> Home
</a>
<script>
    // Timer management
    const INITIAL_TIME = BOARD_SIZE === 4 ? 300 : 180; // 5 min for 4x4x4, 3 min for 3x3x3
    let player1TimeLeft = INITIAL_TIME;
    let player2TimeLeft = INITIAL_TIME;
    let activeTimerInterval = null;
    let gameEnded = false;

    const player1TimerEl = document.getElementById('player1Timer');
    const player2TimerEl = document.getElementById('player2Timer');
    const player1Info = document.getElementById('player1Info');
    const player2Info = document.getElementById('player2Info');

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function updateTimerDisplay() {
        player1TimerEl.textContent = formatTime(player1TimeLeft);
        player2TimerEl.textContent = formatTime(player2TimeLeft);
    }

    function updateActiveHighlight() {
        if (window.playerColor === 'RED') {
            player1Info.classList.add('active');
            player2Info.classList.remove('active');
        } else {
            player1Info.classList.remove('active');
            player2Info.classList.add('active');
        }
    }

    function startTimer() {
        if (activeTimerInterval) {
            clearInterval(activeTimerInterval);
        }

        const startTime = Date.now();
        const initialTime = window.playerColor === 'RED' ? player1TimeLeft : player2TimeLeft;

        activeTimerInterval = setInterval(() => {
            if (gameEnded) {
                clearInterval(activeTimerInterval);
                return;
            }

            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const newTime = Math.max(0, initialTime - elapsed);

            if (window.playerColor === 'RED') {
                player1TimeLeft = newTime;
            } else {
                player2TimeLeft = newTime;
            }

            updateTimerDisplay();

            if (newTime <= 0) {
                clearInterval(activeTimerInterval);
                gameEnded = true;
                const winner = window.playerColor === 'RED' ? 'BLUE' : 'RED';
                handleGameOver(winner, null);
            }
        }, 100);
    }

    function switchPlayer() {
        // Save the remaining time before switching
        if (activeTimerInterval) {
            clearInterval(activeTimerInterval);
        }

        const nextPlayer = window.playerColor === 'RED' ? 'BLUE' : 'RED';
        window.playerColor = nextPlayer;
        highlightMaterial = (nextPlayer === 'RED') ? redHighlightMaterial : blueHighlightMaterial;

        updateActiveHighlight();
        startTimer();
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        const defaultDirectionMapping = { 'FRONT': 'FRONT', 'BACK': 'BACK', 'LEFT': 'LEFT', 'RIGHT': 'RIGHT', 'TOP': 'TOP', 'BOTTOM': 'BOTTOM'};
        localStorage.setItem('directionMapping', JSON.stringify(defaultDirectionMapping));
        highlightMaterial = redHighlightMaterial;

        // Initialize timer display and start Player 1's timer
        updateTimerDisplay();
        startTimer();
    });

    let currentReplayData = null;

    function handleGameOver(winner, winningRun, replayData = null) {
        gameEnded = true;
        if (activeTimerInterval) {
            clearInterval(activeTimerInterval);
        }

        let isTie = !winner
        if (isTie) {
            playSound("move");
        }
        else {
            playSound("win");
        }
        if (!isTie) {
            highlightWinningRun(winner, winningRun);
        }
        savedWinningRun = winningRun;
        currentReplayData = replayData;
        createGameOverUI(winner, null, null, function() {
            location.reload();
        }, false, replayData);
    }

    async function handlePieceClick(piece) {
        currentDirectionMapping = JSON.parse(localStorage.getItem('directionMapping'));
        const direction = sideToDirection(currentDirectionMapping['BACK']);
        const isBlockerMove = window.isBlockerSelected;

        try {
            const response = await fetch('/local/move', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    position: piece.userData.originalPosition,
                    direction: direction,
                    player: window.playerColor,
                    difficulty: '{{ difficulty|safe }}',
                    is_blocker_move: isBlockerMove
                })
            });

            const data = await response.json();

            if (data.status == 'error') {
                let row;
                playSound("invalid");
                if (data.message == 'invalid_move') {
                    row = getRowToJiggle(piece);
                    jigglePieces(row, direction, () => {
                        isJiggling = false;
                    });
                }
                else if (data.message == 'insufficient_power') {
                    showToast("Insufficient power")
                    row = getRowToJiggle(piece);
                    jigglePieces(row, direction, () => {
                        isJiggling = false;
                    });
                }
                else if (data.message == 'max_blocker_moves') {
                    showToast("Max blockers placed")
                    window.isBlockerSelected = false;
                    window.dispatchEvent(new Event('blockerStateChanged'));
                }
            } else {
                if (isBlockerMove) {
                    window.isBlockerSelected = false;
                    window.dispatchEvent(new Event('blockerStateChanged'));
                } else {
                    switchPlayer();
                }

                await updateGameState(data.game_state, data.push_info);
                window.updateControlPanel(data.game_state, data.red_power, data.blue_power);
                playSound("move");

                if (data.winner || data.is_tie) {
                    handleGameOver(data.winner, data.winning_run, data.replay_data);
                }
            }
        } catch (error) {
            console.error('Error:', error);
            showToast("Unexpected Error");
        }
    }
</script>
{% endblock %}
