{% extends 'base_game.html' %}
{% block scripts %}
<style>
    .timer {
        position: absolute;
        top: 20px;
        font-size: 24px;
        color: white;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-radius: 5px;
    }
    #myTimer {
        left: 20px;
    }
    #opponentTimer {
        right: 20px;
    }
</style>
<div id="myTimer" class="timer">Your Time: 03:00</div>
<div id="opponentTimer" class="timer">Opponent's Time: 03:00</div>
<script>
    let currentTurnId; // Store current player's turn ID
    let myId = {{ request.user.id }};

    let myTimeLeft = 180; // 3 minutes in seconds
    let opponentTimeLeft = 180;

    const myTimerElement = document.getElementById('myTimer');
    const opponentTimerElement = document.getElementById('opponentTimer');

    function stopTimers() {
        clearInterval(myInterval);
        clearInterval(opponentInterval);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    let myInterval; // Initialize interval for your timer
    let opponentInterval; // Initialize interval for opponent's timer

    const playerOneId = localStorage.getItem('playerOneId');
    manageTimers(playerOneId);
    localStorage.removeItem('playerOneId');

    function manageTimers(currentTurnId) {
        // Clear both intervals to prevent multiple intervals running simultaneously
        clearInterval(myInterval);
        clearInterval(opponentInterval);

        if (currentTurnId == myId) {
            myInterval = setInterval(() => {
                myTimeLeft--;
                myTimerElement.textContent = `Your Time: ${formatTime(myTimeLeft)}`;
                if (myTimeLeft <= 0) {
                    clearInterval(myInterval);
                }
            }, 1000);
        } else {
            opponentInterval = setInterval(() => {
                opponentTimeLeft--;
                opponentTimerElement.textContent = `Opponent's Time: ${formatTime(opponentTimeLeft)}`;
                if (opponentTimeLeft <= 0) {
                    clearInterval(opponentInterval);
                }
            }, 1000);
        }
    }

    var gameSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/game/' + '{{ game_id }}' + '/'
    );

    gameSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        console.log("RECEIVED gameSocket msg with data" + JSON.stringify(data));
        updateGameState(JSON.parse(data.game_state));
        if (data.winner) {
            handleGameOver(data.winner_name, data.elo_change);
        }
        manageTimers(data.turn)
    };

    function handleGameOver(winner, eloChange) {
        if (eloChange > 0) {
            playSound("win");
        }
        else {
            playSound("lose");
        }
        createGameOverUI(winner, eloChange, function() {
            startWebSocket();
            findOpponent().done(function(response) {
                if (response.status === 'success') {
                    playSound("start");
                    localStorage.setItem('playerOneId', response.turn.id);
                    window.location.href = '/game/' + response.game_id;
                } else if (response.status === 'waiting') {
                    alert('Waiting for an opponent. You will be notified once matched.');
                }
            }).fail(function() {
                alert('Error finding an opponent. Please try again.');
            });
        });
    }

    function handlePieceClick(piece) {
        fetch('/multiplayer/move', {  // Ensure this URL correctly points to your view handling moves
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')  // Ensuring CSRF token is included for Django
            },
            body: JSON.stringify({
                game_id: '{{ game_id }}',  // Pass the current game ID
                position: piece.userData.originalPosition,
                direction: sideToDirection(directionMapping['BACK'])
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("Recieved click with data: ");
            console.log(data);
            playSound("move");
            updateGameState(JSON.parse(data.game_state));  // Update the local state with the new state from the server
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}
